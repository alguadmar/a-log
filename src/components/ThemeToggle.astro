---
import { Button } from '@/components/ui/button'
import { Icon } from 'astro-icon/components'
---

<Button id="theme-toggle" variant="outline" size="icon" title="Cambiar tema">
  <Icon
    name="lucide:sun"
    class="size-4 scale-100 rotate-0 transition-all dark:scale-0 dark:-rotate-90 theme-icon"
  />
  <Icon
    name="lucide:moon"
    class="absolute size-4 scale-0 rotate-90 transition-all dark:scale-100 dark:rotate-0 theme-icon"
  />
  <span class="sr-only">Cambiar tema</span>
</Button>

<style>
  /* Additional styles to prevent icon flash */
  :global(.dark) .theme-icon[data-icon="lucide:sun"] {
    transform: scale(0) rotate(-90deg);
  }
  
  :global(.dark) .theme-icon[data-icon="lucide:moon"] {
    transform: scale(1) rotate(0);
  }
</style>

<script is:inline data-astro-rerun>
  // Now we can optimize this script since the initial theme is 
  // already set in the <head> preload script
  // Using IIFE to avoid global variables
  (function() {
    const currentTheme = (() => {
      const localStorageTheme = localStorage?.getItem('theme') ?? ''
      if (['dark', 'light'].includes(localStorageTheme)) {
        return localStorageTheme
      }
      if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        return 'dark'
      }
      return 'light'
    })()

    // Store the theme in localStorage for persistence
    window.localStorage.setItem('theme', currentTheme)
  })();
</script>

<script>
  function handleToggleClick() {
    const element = document.documentElement

    // Disable transitions and temporarily pause animations
    element.classList.add('disable-transitions')
    element.classList.add('color-scheme-unset')
    
    element.classList.toggle('dark')

    // Force a reflow
    window.getComputedStyle(element).getPropertyValue('opacity')

    // Explicitly set the background color on both html and body
    const isDark = element.classList.contains('dark')
    element.style.backgroundColor = isDark ? '#09090b' : '#ffffff';
    document.body.style.backgroundColor = isDark ? '#09090b' : '#ffffff';

    // Use a small delay to ensure transitions are properly initialized
    setTimeout(() => {
      requestAnimationFrame(() => {
        // Re-enable transitions
        element.classList.remove('disable-transitions')
        element.classList.remove('color-scheme-unset')
        
        // After transitions are enabled, remove the inline styles to let CSS handle it
        setTimeout(() => {
          element.style.backgroundColor = '';
          document.body.style.backgroundColor = '';
        }, 100);
      })
    }, 50);

    localStorage.setItem('theme', isDark ? 'dark' : 'light')
  }

  function initThemeToggle() {
    const themeToggle = document.getElementById('theme-toggle')
    if (themeToggle) {
      themeToggle.addEventListener('click', handleToggleClick)
    }
  }

  initThemeToggle()

  document.addEventListener('astro:after-swap', () => {
    // Using closure to avoid potential variable conflicts
    (function() {
      const storedTheme = localStorage.getItem('theme')
      const element = document.documentElement

      // Immediately disable transitions
      element.classList.add('disable-transitions')
      // Temporarily add color-scheme-unset to ensure animations don't start too early
      element.classList.add('color-scheme-unset')

      // Force a reflow
      window.getComputedStyle(element).getPropertyValue('opacity')

      const isDark = storedTheme === 'dark';
      
      // Explicitly set the background color on both html and body
      element.style.backgroundColor = isDark ? '#09090b' : '#ffffff';
      document.body.style.backgroundColor = isDark ? '#09090b' : '#ffffff';

      if (isDark) {
        element.classList.add('dark')
        
        // Fix icon display after navigation
        const iconFix = document.getElementById('theme-icons-fix');
        if (!iconFix) {
          document.head.insertAdjacentHTML('beforeend', 
            `<style id="theme-icons-fix">
              /* Theme toggle icons fix */
              :root.dark [data-icon="lucide:sun"] { opacity: 0 !important; transform: scale(0) rotate(-90deg) !important; }
              :root.dark [data-icon="lucide:moon"] { opacity: 1 !important; transform: scale(1) rotate(0) !important; }
              
              /* Logo and other dark mode elements */
              :root.dark .dark\\:hidden { display: none !important; }
              :root.dark .hidden.dark\\:block { display: block !important; }
              
              /* Ensure immediate application of icon classes */
              :root.dark img[class*="dark:hidden"] { display: none !important; }
              :root.dark img[class*="hidden"][class*="dark:block"] { display: block !important; }
            </style>`);
        }
      } else {
        element.classList.remove('dark')
        // Remove icon fix if exists
        const iconFix = document.getElementById('theme-icons-fix');
        if (iconFix) {
          iconFix.remove();
        }
      }

      // Use a small delay to ensure all transitions are properly initialized
      setTimeout(() => {
        requestAnimationFrame(() => {
          // Remove transition disabling classes
          element.classList.remove('disable-transitions')
          element.classList.remove('color-scheme-unset')
          
          // After transitions are enabled, remove the inline styles to let CSS handle it
          setTimeout(() => {
            element.style.backgroundColor = '';
            document.body.style.backgroundColor = '';
          }, 100);
        })
      }, 50);
    })();

    // Initialize theme toggle button
    initThemeToggle()
  })
</script>
